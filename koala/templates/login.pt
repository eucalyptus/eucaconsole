<metal:block use-macro="main_template">

<div metal:fill-slot="head_css">
    <link rel="stylesheet" href="${request.static_url('koala:static/css/pages/login.css')}" />
</div>

<div metal:fill-slot="head_js">
    <script type="text/javascript">
      function set_focus() {
        if ($('#eucalyptus').is(':visible')) {
          var inputs = $('#euca-login-form input').filter(function() { return !this.value; });
          if (inputs.length > 0) inputs[0].focus();
        }
        if ($('#aws').is(':visible')) {
          var inputs = $('#aws-login-form input').filter(function() { return !this.value; });
          if (inputs.length > 0) inputs[0].focus();
        }
      }
      function page_loaded() {
          // pre-fill if cookies are present
          var account = $.cookie('account');
          var username = $.cookie('username');
          var remember = $.cookie('remember');
          var accessid = $.cookie('accessid');
          var remember_aws = $.cookie('remember_aws');
          if (account !== undefined) $('#account').val(account);
          if (username !== undefined) $('#username').val(username);
          if (remember !== undefined) $('#remember').prop('checked', true);
          if (accessid !== undefined) $('#access_key').val(accessid);
          if (remember_aws !== undefined) $('#remember_aws').prop('checked', true);

          // this code assures the forms have focus.
          set_focus();
          $('#login-tabs').on('toggled', function (event, tab) {
            set_focus();
          });

          // set up listener to capture and save values if remember checked
          var expiration = 180;
          $('#euca-login-form').submit(function (event) {
            var remember = $('#remember').prop('checked');
            if (remember == true) {
              $.cookie('account', $('#account').val(), {expires: expiration});
              $.cookie('username', $('#username').val(), {expires: expiration});
              $.cookie('remember', 'true', {expires: expiration});
            }
            else {
              $.removeCookie('account');
              $.removeCookie('username');
              $.removeCookie('remember');
            }
          });
          $('#aws-login-form').submit(function (event) {
            var remember = $('#remember_aws').prop('checked');
            if (remember == true) {
              $.cookie('accessid', $('#access_key').val(), {expires: expiration});
              $.cookie('remember_aws', 'true', {expires: expiration});
            }
            else {
              $.removeCookie('accessid');
              $.removeCookie('remember_aws');
            }
          });
      }
    </script>
</div>

<div metal:fill-slot="main_content">

    <div class="row" id="login-panel-wrapper">
        <!-- Notifications -->
        <metal:block metal:use-macro="layout.global_macros['notifications']"></metal:block>
        <div data-alert="alert" class="alert-box alert" tal:condition="https_required and request.scheme != 'https'">
            <span i18n:translate="">
                HTTPS not detected.  You will not be able to log in unless you disable the session.secure setting
                in the configuration file.
            </span>
            <a href="#" class="close">&times;</a>
        </div>
        <div class="large-6 large-centered medium-8 medium-centered columns">
            <div class="row">
                <div tal:condition="login_form_errors">
                  <div data-alert="alert" class="alert-box alert large-10 large-centered columns"
                          tal:repeat="login_error login_form_errors">
                      ${ login_error }
                      <a href="#" class="close">&times;</a>
                  </div>
                </div>
                <dl class="tabs" id="login-tabs" data-tab>
                    <dd id="euca-tab" class="active"><a href="#eucalyptus" i18n:translate="">Log in to Eucalyptus</a></dd>
                    <dd id="aws-tab" tal:condition="layout.aws_enabled"><a href="#aws" i18n:translate="">Log in to AWS</a></dd>
                </dl>
                <div class="tabs-content">
                    <div class="content active" id="eucalyptus">
                      <div id="login-panel">
                        <form class="custom" id="euca-login-form" method="post" name="euca_login_form"
                              action="${request.route_url('login')}?login_type=Eucalyptus">
                            <input type="hidden" name="came_from" value="${came_from}" />
                            <div class="row controls-wrapper controls_${field.name}" tal:repeat="field euca_login_form">
                                <div class="small-12 columns field">
                                    <label for="top-label" class="left">${field.label.text}<span class="req">*</span></label>
                                    ${structure:field}
                                    <div tal:condition="field.errors" class="server-validation">
                                        <span class="error" tal:repeat="error field.errors">
                                            ${error}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                              <div class="small-4 columns"></div>
                              <div class="small-8 columns">
                                <a href="#" i18n:translate="">Forgot your password?</a>
                              </div>
                            </div>
                            <div class="row">
                                <div class="small-4 columns"></div>
                                <div class="small-8 columns">
                                    <input type="submit" class="submit button radius"
                                           id="euca-login-button" value="Log in to Eucalyptus" />
                                </div>
                            </div>
                        </form>
                      </div>
                    </div>
                    <div class="content" tal:condition="layout.aws_enabled" id="aws">
                      <div id="login-panel">
                        <form class="custom" id="aws-login-form" method="post" name="aws_login_form"
                              action="${request.route_url('login')}?login_type=AWS">
                            <input type="hidden" name="came_from" value="${came_from}" />
                            <div class="row controls-wrapper controls_${field.name}" tal:repeat="field aws_login_form">
                                <div class="small-12 columns field">
                                    <label for="top-label" class="left">${field.label.text}<span class="req">*</span></label>
                                    ${structure:field}
                                    <div tal:condition="field.errors" class="server-validation">
                                        <span class="error" tal:repeat="error field.errors">
                                            ${error}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                              <div class="small-4 columns"></div>
                              <div class="small-8 columns">
                                <span i18n:translate="">Need access to an IAM account? Contact your </span>
                                <a href="${layout.support_url}" i18n:translate="">cloud administrator</a>
                              </div>
                            </div>
                            <div class="row">
                                <div class="small-4 columns"></div>
                                <div class="small-8 columns">
                                    <input type="submit" class="submit button radius"
                                           id="aws-login-button" value="Log in to AWS" />
                                </div>
                            </div>
                        </form>
                      </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</metal:block>
