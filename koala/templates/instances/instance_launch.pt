<metal:block use-macro="main_template">

<head metal:fill-slot="head_css">
    <link rel="stylesheet" type="text/css" href="${request.static_url('koala:static/css/thirdparty/chosen.min.css')}" />
    <link rel="stylesheet" type="text/css" href="${request.static_url('koala:static/css/pages/instance_launch.css')}" />
</head>

<div metal:fill-slot="main_content">
    <div class="row" id="contentwrap" ng-app="LaunchInstance" ng-controller="LaunchInstanceCtrl"
         ng-init="initController()">
        <h3 class="header" id="pagetitle">
            <a class="back-arrow" href="${request.route_url('instances')}"
               data-tooltip="" title="Back to instances" i18n:attributes="title">&lt;</a>
            <span i18n:translate="">Launch Instances</span>
        </h3>
        <!-- Notifications -->
        <metal:block metal:use-macro="layout.global_macros['notifications']"></metal:block>
        <div class="large-8 columns" tal:define="_ import: pyramid.i18n.TranslationString">
            <div class="wizard has-title">
                <h6 class="title" i18n:translate="">Launch instance</h6>
                <form action="${request.route_url('instance_launch')}" id="launch-instance-form"
                      method="post" data-abide="abide">
                    ${structure:launch_form['csrf_token']}
                    ${structure:launch_form['image_id']}
                    <dl class="tabs" data-tab="">
                        <dd class="${'active' if not image else ''}">
                            <a id="tabStep1" href="#step1">
                                <span class="cir">1</span> <b>Image</b>
                            </a>
                        </dd>
                        <dd class="${'active' if image else ''}" tal:condition="image">
                            <a id="tabStep2" href="#step2">
                                <span class="cir">2</span> <b>Type</b>
                            </a>
                        </dd>
                        <dd tal:condition="image">
                            <a id="tabStep3" href="#step3">
                                <span class="cir">3</span> <b>Security</b>
                            </a>
                        </dd>
                        <dd tal:condition="image">
                            <a id="tabStep4" href="#step4">
                                <span class="cir">4</span> <b>Advanced</b>
                            </a>
                        </dd>
                    </dl>
                    <div class="tabs-content">
                        <!--! Step 1: Image tab content -->
                        <div class="content ${'active' if not image else ''}" id="step1">
                            <div tal:condition="image" tal:omit-tag="">
                                <p class="description" i18n:translate="">
                                    Machine image for your virtual machine
                                </p>
                                <div class="row controls-wrapper readonly">
                                    <div class="small-4 columns"><label i18n:translate="">Image ID</label></div>
                                    <div class="small-8 columns value">${image.id}</div>
                                </div>
                                <div class="row controls-wrapper readonly">
                                    <div class="small-4 columns"><label i18n:translate="">Image name</label></div>
                                    <div class="small-8 columns value">${image.name}</div>
                                </div>
                                <div class="row controls-wrapper readonly">
                                    <div class="small-4 columns"><label i18n:translate="">Root device type</label></div>
                                    <div class="small-8 columns value">${image.root_device_type}</div>
                                </div>
                                <div class="row controls-wrapper readonly">
                                    <div class="small-4 columns"><label i18n:translate="">Image manifest</label></div>
                                    <div class="small-8 columns value">${image.location}</div>
                                </div>
                                <div class="row controls-wrapper readonly">
                                    <div class="small-4 columns"><label i18n:translate="">Kernel ID</label></div>
                                    <div class="small-8 columns value">${image.kernel_id}</div>
                                </div>
                                <div class="row controls-wrapper readonly">
                                    <div class="small-4 columns"><label i18n:translate="">RAM Disk ID</label></div>
                                    <div class="small-8 columns value">${image.ramdisk_id}</div>
                                </div>
                                <div class="row">
                                    <div class="small-4 columns">&nbsp;</div>
                                    <div class="small-8 columns field inline">
                                        <a id="visit-step-2" class="button small round" ng-click="visitNextStep(2, $event)">
                                            <span i18n:translate="">Next: Select type</span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div tal:condition="not image" tal:omit-tag="">
                                <p class="description" i18n:translate="">
                                    You will need to first
                                    <a href="${request.route_url('images')}">select an image from the list of images</a>
                                    to launch one or more instances.
                                </p>
                                <p i18n:translate="">
                                    Or, enter the Image ID at right to launch one or more instances from that image.
                                </p>
                            </div>
                        </div>
                        <!--! Step 2: Type tab content -->
                        <div class="content ${'active' if image else ''}" id="step2">
                            <p class="description" i18n:translate="">
                                Specify the number of instances, their name(s), the instance size/type, the availability zone, and tags.
                            </p>
                            ${panel('form_field', field=launch_form['number'], maxlength=2, ng_attrs={'model': 'instanceNumber'})}
                            <div class="row controls-wrapper" ng-cloak="">
                                <div class="small-4 columns">
                                    <label i18n:translate="">Names<span class="req">*</span></label>
                                </div>
                                <div class="small-8 columns field inline">
                                    <input class="name" ng-repeat="name in buildNumberList(instanceNumber)"
                                           name="name_{{ $index }}" placeholder="instance{{ $index + 1 }}" required="required" />
                                    <small class="error">Names for each instance are required</small>
                                </div>
                            </div>
                            ${panel('form_field', field=launch_form['instance_type'], ng_attrs={'model': 'instanceType'})}
                            ${panel('form_field', field=launch_form['zone'], ng_attrs={'model': 'instanceZone'})}
                            ${panel('tag_editor')}
                            <div class="row">
                                <div class="small-4 columns">&nbsp;</div>
                                <div class="small-8 columns field inline">
                                    <a id="visit-step-3" class="button small round" ng-click="visitNextStep(3, $event)">
                                        <span i18n:translate="">Next: Select security</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <!--! Step 3: Security tab content -->
                        <div class="content" id="step3">
                            <p class="description" i18n:translate="">
                                Specify the key pair and security group.
                            </p>
                            ${panel('form_field', field=launch_form['keypair'], ng_attrs={'model': 'keyPair'})}
                            ${panel('form_field', field=launch_form['securitygroup'], ng_attrs={'model': 'securityGroup'})}
                            <div class="row">
                                <div class="small-4 columns">&nbsp;</div>
                                <div class="small-8 columns field inline">
                                    <button type="submit" class="button">
                                        <span i18n:translate="">Launch instance<span ng-show="instanceNumber > 1">s</span></span>
                                    </button><br />
                                    <span class="or">Or:</span>
                                    <a id="visit-step-4" ng-click="visitNextStep(4, $event)">
                                        <span i18n:translate="">Select advanced options</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <!--! Step 4: Advanced tab content -->
                        <div class="content" id="step4">
                            <p class="description" i18n:translate="">
                                User data and other advanced options (optional).
                            </p>
                            ${panel('form_field', field=launch_form['userdata'])}
                            ${panel('form_field', field=launch_form['kernel_id'])}
                            ${panel('form_field', field=launch_form['ramdisk_id'])}
                            ${panel('form_field', field=launch_form['monitoring_enabled'])}
                            ${panel('form_field', field=launch_form['private_addressing'])}
                            ${panel('bdmapping_editor', image=image)}
                            <div class="row" tal:condition="image">
                                <div class="small-4 columns">&nbsp;</div>
                                <div class="small-8 columns field inline">
                                    <button type="submit" class="button">
                                        <span i18n:translate="">Launch instance<span ng-show="instanceNumber > 1">s</span></span>
                                    </button>
                                    <a href="${request.route_url('instances')}"
                                       class="cancel-link" i18n:translate="">Cancel</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="clearfix">&nbsp;</div>
                </form>
            </div>
        </div>
        <div class="large-4 columns summary" ng-cloak="">
            <div tal:condition="image" tal:omit-tag="">
                <h5 i18n:translate="" class="title">Summary</h5>
                <div class="section">
                    <div class="row">
                        <div class="small-4 columns"><label i18n:translate="" class="right">Image:</label></div>
                        <div class="small-8 columns value">${image.name or image.id}</div>
                    </div>
                    <div class="row">
                        <div class="small-4 columns"><label i18n:translate="" class="right">Platform:</label></div>
                        <div class="small-8 columns value">${image.platform}</div>
                    </div>
                </div>
                <div class="section">
                    <div class="row">
                        <div class="small-4 columns"><label i18n:translate="" class="right">Instances:</label></div>
                        <div class="small-8 columns value">{{ instanceNumber }}</div>
                    </div>
                    <div class="row">
                        <div class="small-4 columns"><label i18n:translate="" class="right">Type:</label></div>
                        <div class="small-8 columns value">{{ instanceType }}</div>
                    </div>
                    <div class="row">
                        <div class="small-4 columns"><label i18n:translate="" class="right">Zone:</label></div>
                        <div class="small-8 columns value">{{ instanceZone }}</div>
                    </div>
                    <div class="row">
                        <div class="small-4 columns"><label i18n:translate="" class="right">Tags:</label></div>
                        <div class="small-8 columns value" id="tag-preview">
                            <div ng-repeat="(name, value) in tagsObject">{{ name }}={{ value }}</div>
                        </div>
                    </div>
                </div>
                <div class="section">
                    <div class="row">
                        <div class="small-4 columns"><label i18n:translate="" class="right">Key pair:</label></div>
                        <div class="small-8 columns value">{{ keyPair }}</div>
                    </div>
                    <div class="row">
                        <div class="small-4 columns"><label i18n:translate="" class="right">Security group:</label></div>
                        <div class="small-8 columns value">{{ securityGroup }}</div>
                    </div>
                </div>
            </div>
            <div tal:condition="not image">
                <h6 i18n:translate="" class="title">Enter Image ID</h6>
                <!--! OK to use GET request here, since we're just looking up the image -->
                <form action="${request.route_url('instance_create')}" method="get">
                    <div class="row">
                        <div class="small-4 columns"><label i18n:translate="" class="right">Image ID:</label></div>
                        <div class="small-8 columns value">
                            <input type="text" name="image_id" id="image-id-input" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="small-4 columns">&nbsp;</div>
                        <div class="small-8 columns value">
                            <input type="submit" class="button small" />
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div metal:fill-slot="tail_js">
    <script src="${request.static_url('koala:static/js/thirdparty/utils/purl.js')}"></script>
    <script src="${request.static_url('koala:static/js/pages/instance_launch.js')}"></script>
</div>

</metal:block>

